---
- hosts: all
  become: yes

  vars:
    k3s_version: "v1.31.4+k3s1"
    helm_version: "v3.17.0"
    jenkins_chart_version: "5.8.122"
    jenkins_tag: "2.528.3-lts"
    registry_image_tag: "2.8.3"
    kubeconfig_path: "/etc/rancher/k3s/k3s.yaml"
    target_user: "{{ ansible_user | default(ansible_user_id) }}"

  tasks:

    # Comentar si la maquina es pobre
    - name: Updated only cache for DNF
      ansible.builtin.dnf:
        update_cache: yes

    - name: Open firewall ports
      ansible.posix.firewalld:
        port: "{{ item }}"
        permanent: yes
        state: enabled
        immediate: yes
      loop:
        - 8080/tcp
        - 5000/tcp
        - 6443/tcp
        - 80/tcp
        - 443/tcp
        - 30000-32767/tcp

    - name: Instalar Podman y herramientas base
      ansible.builtin.dnf:
        name: [curl, git, unzip, gettext, podman, podman-docker]
        state: present

    - name: Clonar el repositorio del proyecto
      ansible.builtin.git:
        repo: 'https://github.com/memecito/devops-challenge-01.git'
        dest: /home/vagrant/reto-petclinic
        version: master

    - name: Descargar e instalar K3s
      ansible.builtin.shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ k3s_version }}" INSTALL_K3S_EXEC="--disable traefik --write-kubeconfig-mode 644" sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Configurar permisos de K3s
      ansible.builtin.file:
        path: "{{ kubeconfig_path }}"
        mode: '0644'
        owner: "{{ target_user }}"

    - name: Crear symlink para kubectl
      ansible.builtin.file:
        src: /usr/local/bin/k3s
        dest: /usr/bin/kubectl
        state: link

    - name: Levantar registro con Podman
      containers.podman.podman_container:
        name: registry
        image: "registry:{{ registry_image_tag }}"
        state: started
        recreate: yes
        publish: ["5000:5000"]

    - name: Instalar Java 17 y Maven
      ansible.builtin.dnf:
        name: [java-17-openjdk-devel, maven]
        state: present

    - name: Instalar Helm
      ansible.builtin.unarchive:
        src: "https://get.helm.sh/helm-{{ helm_version }}-linux-amd64.tar.gz"
        dest: /tmp
        remote_src: yes

    - name: Mover Helm a /usr/bin
      ansible.builtin.copy:
        src: /tmp/linux-amd64/helm
        dest: /usr/bin/helm
        mode: '0755'
        remote_src: yes

    - name: Instalar dependencias de Python para K8s
      ansible.builtin.dnf:
        name: [python3-pip, python3-pyyaml]
        state: present

    - name: Instalar librerías de python (K8s)
      ansible.builtin.pip:
        name: [kubernetes==31.0.0, jsonpatch==1.33]

    - name: Añadir repo de Helm de Jenkins
      kubernetes.core.helm_repository:
        name: jenkins
        repo_url: "https://charts.jenkins.io"

    - name: Instalar Jenkins con Helm y JCasC
      kubernetes.core.helm:
        name: jenkins
        chart_ref: jenkins/jenkins
        chart_version: "{{ jenkins_chart_version }}"
        release_namespace: devops-tools
        create_namespace: true
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          controller:
            resources:
              requests:
                cpu: "500m"
                memory: "1024Mi"
              limits:
                cpu: "2000m"
                memory: "4096Mi"
            # Damos más tiempo para que arranque (importante en VirtualBox)
            healthProbes:
              initialDelaySeconds: 160
              periodSeconds: 20
            image:
              tag: "{{ jenkins_tag }}"
            admin:
              username: "admin"
              password: "jenkins-1234"
            serviceType: NodePort
            nodePort: 32195
            # Instalamos los plugins necesarios para que el pipeline no falle
            installPlugins:
              - "kubernetes:"
              - "workflow-aggregator"
              - "git"
              - "job-dsl"
              - "configuration-as-code"
            JCasC:
              enabled: true
              defaultConfig: true
              configScripts:
                pipeline-job: |
                  jobs:
                    - script: >
                        pipelineJob('petclinic-pipeline') {
                          definition {
                            cpsScm {
                              scm {
                                git {
                                  remote {
                                    url('https://github.com/memecito/devops-chagenge-01.git')
                                  }
                                  branches('master')
                                }
                              }
                            }
                          }
                        }

    - name: Esperar a que el servicio de Jenkins esté listo y obtener puerto
      ansible.builtin.shell: |
        kubectl get svc jenkins -n devops-tools --kubeconfig {{ kubeconfig_path }} -o jsonpath='{.spec.ports[0].nodePort}'
      register: jenkins_port
      until: jenkins_port.rc == 0
      retries: 10
      delay: 5

    - name: URL de acceso a Jenkins
      ansible.builtin.debug:
        msg: "Acceso: http://{{ ansible_default_ipv4.address }}:{{ jenkins_port.stdout }} (Usuario: admin / Pass: jenkins-1234)"