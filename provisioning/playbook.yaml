---
- hosts: all
  become: yes

  tasks:
    # --- PREPARACIÓN DEL S.O. ---
    - name: Upgrade all packages
      ansible.builtin.dnf:
        name: "*"
        state: latest

    - name: Open firewall ports
      ansible.builtin.firewalld:
        port: "{{ item }}"
        permanent: yes
        state: enabled
        immediate: yes
      loop:
        - 8080/tcp   # Jenkins
        - 5000/tcp   # Registry
        - 6443/tcp   # K3s API
        - 80/tcp
        - 443/tcp
        - 30000-32767/tcp # Rango NodePort de K8s

    # --- INSTALACIÓN DE MOTORES (PODMAN) ---
    - name: Instalar Podman y herramientas base
      ansible.builtin.dnf:
        name:
          - curl
          - git
          - unzip
          - gettext
          - podman
          - podman-docker
        state: present

    # --- K3S ---
    - name: Descargar e instalar K3s
      shell: curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--disable traefik" sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Configurar permisos de K3s para el usuario vagrant
      file:
        path: /etc/rancher/k3s/k3s.yaml
        mode: '0644'
        owner: user # cambiar a 'vagrant' cuando se use Vagrant

    # --- REGISTRO LOCAL CON PODMAN ---
    # Nota: Podman no necesita daemon.json. Usamos un contenedor de registro.
    - name: Levantar registro con Podman
      containers.podman.podman_container:
        name: registry
        image: registry:2
        state: started
        recreate: yes
        publishes:
          - "5000:5000"

    # --- JAVA Y MAVEN (Nombres correctos para Rocky) ---
    - name: Instalar Java 17 y Maven
      ansible.builtin.dnf:
        name:
          - java-17-openjdk-devel
          - maven
        state: present

    # --- HELM Y JENKINS ---
    - name: Install Helm
      shell: curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

    - name: Instalar dependencias de Python para K8s
      ansible.builtin.dnf:
        name: 
          - python3-pip
          - python3-pyyaml
        state: present

    - name: Instalar libreria kubernetes de python
      pip:
        name: kubernetes

    - name: Add Jenkins repo
      kubernetes.core.helm_repository:
        name: jenkins
        repo_url: "https://charts.jenkins.io"

    - name: Instalar Jenkins con Helm
      kubernetes.core.helm:
        name: jenkins
        chart_ref: jenkins/jenkins
        release_namespace: devops-tools
        create_namespace: true
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        values:
          controller:
            adminUser: "admin"          # Tu usuario personalizado
            adminPassword: "jenkins-1234" # Tu contraseña personalizada
            serviceType: NodePort

    - name: Obtener el puerto de Jenkins
      ansible.builtin.shell: kubectl get svc jenkins -n devops-tools -o jsonpath='{.spec.ports[0].nodePort}'
      register: jenkins_port

    - name: URL de acceso a Jenkins
      ansible.builtin.debug:
        msg: "Accede a Jenkins en: http://{{ ansible_default_ipv4.address }}:{{ jenkins_port.stdout }}"

